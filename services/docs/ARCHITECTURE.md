# OAuth2/OIDC Architecture Diagram

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Client Application                          │
│                     (Browser, Mobile App, etc.)                     │
└────────────────┬────────────────────────────────────────────────────┘
                 │
                 │ 1. Request Authorization
                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Authorization Server (Port 3000)                  │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    OAuth2/OIDC Endpoints                      │ │
│  │  • POST /auth/register                                        │ │
│  │  • POST /auth/login                                           │ │
│  │  • GET  /oauth/authorize                                      │ │
│  │  • POST /oauth/token                                          │ │
│  │  • GET  /oauth/userinfo                                       │ │
│  │  • POST /oauth/revoke                                         │ │
│  │  • GET  /.well-known/openid-configuration                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      Token Manager                            │ │
│  │  • Access Token (JWT): 15 min                                 │ │
│  │  • Refresh Token (UUID): 7 days                               │ │
│  │  • ID Token (JWT): 1 hour                                     │ │
│  └───────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                     Database Models                           │ │
│  │  • Users         • Clients                                    │ │
│  │  • AuthCodes     • RefreshTokens                              │ │
│  └───────────────────────────────────────────────────────────────┘ │
└────────────────┬────────────────────────────────────────────────────┘
                 │
                 │ 2. Return Tokens
                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Resource Servers                               │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────┐  ┌────────────────────┐                    │
│  │ Products (3001)    │  │ Categories (3002)  │                    │
│  │ ┌────────────────┐ │  │ ┌────────────────┐ │                    │
│  │ │ Public Reads   │ │  │ │ Public Reads   │ │                    │
│  │ │ Admin Writes   │ │  │ │ Admin Writes   │ │                    │
│  │ └────────────────┘ │  │ └────────────────┘ │                    │
│  └────────────────────┘  └────────────────────┘                    │
│  ┌────────────────────┐  ┌────────────────────┐                    │
│  │ Users (3003)       │  │ Orders (3004)      │                    │
│  │ ┌────────────────┐ │  │ ┌────────────────┐ │                    │
│  │ │ Self/Admin     │ │  │ │ Owner/Admin    │ │                    │
│  │ │ Access         │ │  │ │ Access         │ │                    │
│  │ └────────────────┘ │  │ └────────────────┘ │                    │
│  └────────────────────┘  └────────────────────┘                    │
│                                                                      │
│  Each service has:                                                  │
│  • OAuth2 Middleware (verifyAccessToken, requireRole, etc.)        │
│  • JWT Verification                                                 │
│  • Role-Based Access Control                                       │
└─────────────────────────────────────────────────────────────────────┘
                 │
                 │ 3. Access Protected Resources
                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         MongoDB Databases                           │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐          │
│  │  auth_db  │ │products_db│ │categories │ │  users_db │ ┌──────┐ │
│  │           │ │           │ │    _db    │ │           │ │orders│ │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ │ _db  │ │
│                                                            └──────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## Authentication Flow Diagram

```
┌────────┐                                         ┌──────────────┐
│ Client │                                         │ Auth Server  │
└───┬────┘                                         └──────┬───────┘
    │                                                     │
    │ 1. GET /oauth/authorize?response_type=code...      │
    │─────────────────────────────────────────────────────▶
    │                                                     │
    │ 2. Redirect to login page                          │
    │◀─────────────────────────────────────────────────────
    │                                                     │
    │ 3. POST /auth/login (email, password)              │
    │─────────────────────────────────────────────────────▶
    │                                                     │
    │                              ┌──────────────────┐  │
    │                              │ Validate User    │  │
    │                              │ Generate Code    │  │
    │                              └──────────────────┘  │
    │                                                     │
    │ 4. Return authorization code                       │
    │◀─────────────────────────────────────────────────────
    │                                                     │
    │ 5. POST /oauth/token (code, client_secret)         │
    │─────────────────────────────────────────────────────▶
    │                                                     │
    │                              ┌──────────────────┐  │
    │                              │ Validate Code    │  │
    │                              │ Generate Tokens  │  │
    │                              └──────────────────┘  │
    │                                                     │
    │ 6. Return tokens (access, refresh, id)             │
    │◀─────────────────────────────────────────────────────
    │                                                     │
    │                                                     │
┌───┴────┐                                         ┌──────┴────────┐
│ Client │                                         │ Resource      │
│        │                                         │ Server        │
└───┬────┘                                         └──────┬────────┘
    │                                                     │
    │ 7. GET /api/products                                │
    │    Authorization: Bearer <access_token>             │
    │─────────────────────────────────────────────────────▶
    │                                                     │
    │                              ┌──────────────────┐  │
    │                              │ Verify Token     │  │
    │                              │ Check Permissions│  │
    │                              │ Process Request  │  │
    │                              └──────────────────┘  │
    │                                                     │
    │ 8. Return resource data                             │
    │◀─────────────────────────────────────────────────────
    │                                                     │
```

## Token Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                      Access Token (JWT)                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Header                                                    │ │
│  │  { "alg": "HS256", "typ": "JWT" }                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Payload                                                   │ │
│  │  {                                                        │ │
│  │    "sub": "user_id",                                      │ │
│  │    "email": "user@example.com",                           │ │
│  │    "roles": ["user", "admin"],                            │ │
│  │    "scope": ["openid", "profile", "email"],               │ │
│  │    "token_type": "access_token",                          │ │
│  │    "iss": "http://localhost:3000",                        │ │
│  │    "aud": "ecommerce-client",                             │ │
│  │    "exp": 1234567890,                                     │ │
│  │    "iat": 1234567000                                      │ │
│  │  }                                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Signature                                                 │ │
│  │  HMACSHA256(base64UrlEncode(header) + "." +              │ │
│  │              base64UrlEncode(payload),                    │ │
│  │              ACCESS_TOKEN_SECRET)                         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  Lifetime: 15 minutes                                           │
│  Used for: API authentication                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Refresh Token (Opaque)                       │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Token: uuid-v4-string                                     │ │
│  │ Stored in Database:                                       │ │
│  │  - token (indexed)                                        │ │
│  │  - user_id                                                │ │
│  │  - client_id                                              │ │
│  │  - scope                                                  │ │
│  │  - expires_at                                             │ │
│  │  - revoked (boolean)                                      │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  Lifetime: 7 days                                               │
│  Used for: Getting new access tokens                            │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      ID Token (JWT - OIDC)                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Header                                                    │ │
│  │  { "alg": "HS256", "typ": "JWT" }                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Payload (OIDC Standard Claims)                            │ │
│  │  {                                                        │ │
│  │    "sub": "user_id",                                      │ │
│  │    "email": "user@example.com",                           │ │
│  │    "email_verified": false,                               │ │
│  │    "name": "John Doe",                                    │ │
│  │    "given_name": "John",                                  │ │
│  │    "family_name": "Doe",                                  │ │
│  │    "picture": null,                                       │ │
│  │    "phone_number": "+1234567890",                         │ │
│  │    "address": {...},                                      │ │
│  │    "updated_at": "2025-01-18T00:00:00.000Z",              │ │
│  │    "token_type": "id_token",                              │ │
│  │    "iss": "http://localhost:3000",                        │ │
│  │    "aud": "ecommerce-client"                              │ │
│  │  }                                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  Lifetime: 1 hour                                               │
│  Used for: User identity information                            │
└─────────────────────────────────────────────────────────────────┘
```

## Middleware Flow Diagram

```
┌───────────────────────────────────────────────────────────────────┐
│              HTTP Request to Protected Endpoint                   │
└────────────────────────────┬──────────────────────────────────────┘
                             │
                             ▼
            ┌────────────────────────────────┐
            │  Extract Authorization Header  │
            │  "Bearer <token>"              │
            └────────────┬───────────────────┘
                         │
                         ▼
            ┌────────────────────────────────┐
            │  Verify Token Present?         │
            └────────┬───────────────────────┘
                     │
         ┌───────────┴──────────┐
         │                      │
    No   │                      │  Yes
         ▼                      ▼
    ┌─────────┐      ┌────────────────────┐
    │ Return  │      │ Verify JWT         │
    │ 401     │      │ • Signature        │
    └─────────┘      │ • Expiration       │
                     │ • Issuer           │
                     └─────────┬──────────┘
                               │
                     ┌─────────┴──────────┐
                     │                    │
                 Valid                 Invalid
                     │                    │
                     ▼                    ▼
          ┌──────────────────┐      ┌─────────┐
          │ Extract Claims   │      │ Return  │
          │ • sub (user ID)  │      │ 401     │
          │ • roles          │      └─────────┘
          │ • scope          │
          └────────┬─────────┘
                   │
                   ▼
          ┌──────────────────┐
          │ Check Role?      │
          └────────┬─────────┘
                   │
         ┌─────────┴──────────┐
         │                    │
    Required                Not Required
         │                    │
         ▼                    ▼
   ┌──────────┐         ┌──────────┐
   │Has Role? │         │Attach    │
   └────┬─────┘         │User to   │
        │               │Request   │
   ┌────┴────┐          └────┬─────┘
   │         │               │
  Yes       No               ▼
   │         │          ┌──────────┐
   │         ▼          │ Call     │
   │    ┌─────────┐    │ Next()   │
   │    │ Return  │    └──────────┘
   │    │ 403     │
   │    └─────────┘
   │
   ▼
┌──────────┐
│Attach    │
│User to   │
│Request   │
└────┬─────┘
     │
     ▼
┌──────────┐
│ Call     │
│ Next()   │
└──────────┘
```

## Service Access Control Matrix

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Products Service (3001)                         │
├──────────────────────┬──────────────────────────────────────────────┤
│ Endpoint             │ Access Control                               │
├──────────────────────┼──────────────────────────────────────────────┤
│ GET /api/products    │ ┌────────────────────────────────────────┐  │
│                      │ │ optionalAuth                           │  │
│                      │ │ • Anonymous: ✓ Basic data              │  │
│                      │ │ • Authenticated: ✓ Enhanced data       │  │
│                      │ └────────────────────────────────────────┘  │
├──────────────────────┼──────────────────────────────────────────────┤
│ POST /api/products   │ ┌────────────────────────────────────────┐  │
│                      │ │ verifyAccessToken → requireRole('admin')│ │
│                      │ │ • Must have valid token                │  │
│                      │ │ • Must have admin role                 │  │
│                      │ └────────────────────────────────────────┘  │
└──────────────────────┴──────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                     Orders Service (3004)                           │
├──────────────────────┬──────────────────────────────────────────────┤
│ Endpoint             │ Access Control                               │
├──────────────────────┼──────────────────────────────────────────────┤
│ GET /api/orders      │ ┌────────────────────────────────────────┐  │
│                      │ │ verifyAccessToken → requireRole('admin')│ │
│                      │ │ • Admin only                           │  │
│                      │ └────────────────────────────────────────┘  │
├──────────────────────┼──────────────────────────────────────────────┤
│ GET /api/orders/     │ ┌────────────────────────────────────────┐  │
│     user/:userId     │ │ verifyAccessToken →                    │  │
│                      │ │ requireOwnerOrAdmin                    │  │
│                      │ │ • User can view own orders             │  │
│                      │ │ • Admin can view all orders            │  │
│                      │ └────────────────────────────────────────┘  │
└──────────────────────┴──────────────────────────────────────────────┘
```

## Deployment Architecture

```
┌────────────────────────────────────────────────────────────────┐
│                        Load Balancer                           │
│                         (HTTPS/SSL)                            │
└────────────────┬───────────────────────────────────────────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│  Auth   │ │Products │ │Categories│
│ Server  │ │ Service │ │ Service │
│  :3000  │ │  :3001  │ │  :3002  │
└────┬────┘ └────┬────┘ └────┬────┘
     │           │           │
     └───────────┼───────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│  Users  │ │ Orders  │ │   API   │
│ Service │ │ Service │ │ Gateway │
│  :3003  │ │  :3004  │ │  (opt)  │
└────┬────┘ └────┬────┘ └────┬────┘
     │           │           │
     └───────────┼───────────┘
                 │
                 ▼
    ┌────────────────────────┐
    │   MongoDB Cluster      │
    │  • auth_db             │
    │  • products_db         │
    │  • categories_db       │
    │  • users_db            │
    │  • orders_db           │
    └────────────────────────┘
```

## Technology Stack

```
┌─────────────────────────────────────────────────────────────────┐
│                      Frontend Layer                             │
│  • React / Vue / Angular / Mobile Apps                          │
│  • OAuth2 Client Library                                        │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    API Gateway (Optional)                       │
│  • Request Routing                                              │
│  • Rate Limiting                                                │
│  • Request Logging                                              │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Authorization Layer                          │
│  • OAuth2 / OpenID Connect                                      │
│  • JWT Token Management                                         │
│  • User Authentication                                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Microservices Layer                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Node.js + Express                                      │   │
│  │  • MVC Architecture                                     │   │
│  │  • OAuth2 Middleware                                    │   │
│  │  • JWT Verification                                     │   │
│  │  • Role-Based Access Control                            │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Data Layer                                 │
│  • MongoDB (NoSQL)                                              │
│  • Mongoose ODM                                                 │
│  • Database per Service Pattern                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Security Layers

```
┌─────────────────────────────────────────────────────────────────┐
│ Layer 1: Transport Security                                     │
│  • HTTPS/TLS                                                    │
│  • Certificate Management                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Layer 2: Authentication                                         │
│  • OAuth2 Authorization Code Flow                               │
│  • Password Hashing (bcrypt)                                    │
│  • JWT Token Validation                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Layer 3: Authorization                                          │
│  • Role-Based Access Control (RBAC)                             │
│  • Scope Validation                                             │
│  • Resource Ownership Checks                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Layer 4: Data Security                                          │
│  • MongoDB Authentication                                       │
│  • Encryption at Rest                                           │
│  • Input Validation & Sanitization                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Layer 5: Monitoring & Auditing                                 │
│  • Access Logs                                                  │
│  • Security Event Monitoring                                    │
│  • Audit Trails                                                 │
└─────────────────────────────────────────────────────────────────┘
```
